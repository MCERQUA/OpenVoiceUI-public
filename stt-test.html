<!DOCTYPE html>
<html>
<head><title>STT Test</title></head>
<body style="background:#111;color:#0f0;font-family:monospace;padding:20px">
<h2>Web Speech API Diagnostic</h2>
<button id="start" style="padding:15px 30px;font-size:18px;cursor:pointer">START STT</button>
<button id="stop" style="padding:15px 30px;font-size:18px;cursor:pointer">STOP</button>
<pre id="log" style="margin-top:20px;white-space:pre-wrap"></pre>
<script>
const log = (msg) => {
    const el = document.getElementById('log');
    const ts = new Date().toLocaleTimeString();
    el.textContent += `[${ts}] ${msg}\n`;
    console.log(msg);
};

const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SR) { log('ERROR: SpeechRecognition not supported'); }
else { log('SpeechRecognition API available'); }

let recognition = null;

document.getElementById('start').onclick = async () => {
    log('--- Starting test ---');

    // Test 1: getUserMedia
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log('OK: Mic permission granted');
        stream.getTracks().forEach(t => t.stop());
    } catch(e) {
        log('FAIL: Mic permission denied: ' + e.message);
        return;
    }

    // Test 2: SpeechRecognition (non-continuous)
    log('Test: Starting recognition (continuous=false)...');
    recognition = new SR();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => log('EVENT: onstart - recognition is listening');
    recognition.onaudiostart = () => log('EVENT: onaudiostart - audio capture started');
    recognition.onsoundstart = () => log('EVENT: onsoundstart - sound detected');
    recognition.onspeechstart = () => log('EVENT: onspeechstart - speech detected');
    recognition.onspeechend = () => log('EVENT: onspeechend - speech ended');
    recognition.onsoundend = () => log('EVENT: onsoundend - sound ended');
    recognition.onaudioend = () => log('EVENT: onaudioend - audio capture ended');

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        log('RESULT: "' + text + '" (confidence: ' + event.results[0][0].confidence.toFixed(2) + ')');
    };

    recognition.onerror = (event) => {
        log('ERROR: ' + event.error + ' (message: ' + (event.message || 'none') + ')');
    };

    recognition.onend = () => {
        log('EVENT: onend - recognition ended');
    };

    try {
        recognition.start();
        log('recognition.start() called successfully');
    } catch(e) {
        log('FAIL: recognition.start() threw: ' + e.message);
    }
};

document.getElementById('stop').onclick = () => {
    if (recognition) {
        recognition.stop();
        log('Stopped');
    }
};

log('Page loaded. Click START to test.');
log('Browser: ' + navigator.userAgent);
</script>
</body>
</html>
